---
tags:
  - 题解
  - 堆/对顶堆
aliases:
  - K. Rainbow Subarray
---
## [K. Rainbow Subarray](https://codeforces.com/gym/104901/problem/K)



#### [AC代码](https://codeforces.com/gym/104901/submission/288679360)

```cpp
#include <bits/stdc++.h>

using namespace std;
typedef long long ll;

const int N=5e5+5;
int n, a[N];
ll k;

struct PHP {
    int sz;
    multiset <int> minH, maxH;
    ll minS, maxS;
    void clear()
    {
        minH.clear();
        maxH.clear();
        sz = minS = maxS = 0;
    }
    void move()
    {
        while ((int)minH.size() < (sz+1)/2) {
            minS += *maxH.rbegin();
            minH.insert(*maxH.rbegin());
            maxS -= *maxH.rbegin();
            maxH.erase(maxH.find(*maxH.rbegin()));
        }
        while ((int)minH.size() > (sz+1)/2) {
            maxS += *minH.begin();
            maxH.insert(*minH.begin());
            minS -= *minH.begin();
            minH.erase(minH.find(*minH.begin()));
        }
    }
    void add(int x)
    {
        ++sz;
        if (minH.empty() || x >= *minH.begin()) {
            minS += x;
            minH.insert(x);
        } else {
            maxS += x;
            maxH.insert(x);
        }
        move();
    }
    void del(int x)
    {
        --sz;
        if (x >= *minH.begin()) {
            minS -= x;
            minH.erase(minH.find(x));
        } else {
            maxS -= x;
            maxH.erase(maxH.find(x));
        }
        move();
    }
    ll med()
    {
        return *minH.begin();
    }
    ll dis_to_med()
    {
        ll minSZ=(sz+1)/2, maxSZ=sz-minSZ, m=med();
        return (minS-minSZ*m)+(maxSZ*m-maxS);
    }
} p;

void solve()
{
    cin >> n >> k;
    p.clear();
    for (int i = 1; i <= n; ++i) {
        cin >> a[i];
        a[i] = a[i] - i;
    }
    int L=1, R=1, ans=1;
    while (R <= n) {
        p.add(a[R]);
        while (L<R && p.dis_to_med() > k) { p.del(a[L++]); }
        ans = max(ans, R-L+1);
        ++R;
    }
    cout << ans << endl;
}

int main()
{
    cin.tie() -> sync_with_stdio(false);
    int t; cin >> t;
    while (t--) { solve(); }
}
```
