---
tags:
  - 碎片
  - OI
  - OI/堆
  - OI/反悔贪心
---
## [CF865D Buy Low Sell High](https://www.luogu.com.cn/problem/CF865D)

反悔贪心模板题。

假设现在是第 $i$ 天，对于前 $i-1$ 天【尚未购买】的股票，将其加入【代购清单】。
当前的最优策略是：从代购清单中选择价格最小的那一天买入，并在第 $i$ 天卖出。

但局部的最优解不一定是全局最优解，比如下面这组数据就可以卡掉普通贪心：
```
4
1 2 100 100
```
但我们可以发现的是，虽然题目说一天只能进行一次操作，但在一天内买入和卖出的操作是可以完美抵消的，也就是【做了跟没做一样】。

**所以，我们可以【先买着】，等发现更优的情况再【反悔】。**

具体而言，如果现在是第 $i$ 天，我在第 $j\ (j<i)$ 天贪心地选择买入，而在第 $i$ 天卖出。但我只将第 $j$ 天的价格移出代购清单，而在代购清单中加入两遍第 $i$ 天的价格。

这样一来，如果我选择反悔，那么只需要在第 $i$ 天再卖出，一买一卖完美抵消，对答案没有影响。

如果我在后续第 $k\ (i<k)$ 天卖出第 $i$ 天的股票，由于代购清单中加入了两遍第 $i$ 天的价格，同样不影响答案。

比如，对于上述的数据：

- 在第一天无法卖出，将 `1` 加入代购清单。
	- 【此时的代购清单：`1`，收益为 `0` 元。】
- 第二天的价格大于第一天，所以先买着，将 `1` 移出代购清单，再往里面加入两个 `2`。
	- 【此时的代购清单为：`2, 2`，收益为 `1` 元，即第一天买入，第二天卖出。】
- 第三天的价格大于第二天，也大于第一天。此时可以反悔上一步的操作，将一个 `2` 移出清单，收益加上 `100-2`，将两个 `100` 加入清单。
	- 【此时代购清单：`2, 100, 100`，收益为 `99` 元，即第一天买入，第三天卖出。】
- 第四天价格大于第二天，可以在第二天买入，第四天卖出。（如果选择反悔或在第三天买入，那么额外收益为 0）
	- 【此时的代购清单：`100, 100, 100, 100`，收益为 `197` 元，即第一、二天买入，第三、四天卖出。】
- 最终答案即为 `197` 元。

[AC 代码提交记录](https://www.luogu.com.cn/record/126714455)

```cpp
#include <bits/stdc++.h>
#define ll long long

using namespace std;

int n;
long long p, ans;

priority_queue <ll, vector<ll>, greater<ll> > q;

int main()
{
	cin >> n;
	for (int i = 1; i <= n; ++i) {
		cin >> p;
		if ( (!q.empty()) && (p > q.top())) { ans += p-q.top(); q.pop(); q.push(p); }
		q.push(p);
	}
	cout << ans << endl;
	return 0;
}
```
